# 쿼리 튜닝에 필요한 용어들

## DB엔진 용어

: DB엔진과 관련된 용어들

### 과정 개요

MYSQL이라는 DBMS 가 SQL문을 어떻게 처리하는가?

![IMG_4989.jpeg](https://prod-files-secure.s3.us-west-2.amazonaws.com/acc36000-d256-402d-b556-1ea406ceaf8a/c8baa2e8-8de6-4e46-87d0-5f0627d9b69e/IMG_4989.jpeg)

SQL문 실행 → 문법 및 구문으로 유효성 검사 (parsor) → 최적화된 검색 계획 수립(optimizer)→데이터 전달

### 스토리지 엔진

SQL문을 토대로 저장소에서 데이터를 가져와서, MySQL엔진으로 보내는 역할

저장 방식에 따라 다양한 종류 존재. 

온라인 상 트랜잭션으로 데이터 처리하는 OLTP 환경에 맞는 InnoDB 엔진 사용.

대량의 쓰기 트랜잭션은 MyISAM엔진, 빠른 읽기 속도의 Memory 엔진등이 있음.

### MySQL 엔진

사용자가 요청한 SQL문을 넘겨받은 뒤, 문법/오브젝트 활용 등의 검사 수행.

SQL문을 최소단위로 분리해서 최단 데이터 검색 경로 모색.

스토리지 엔진으로부터 전달받은 데이터 가공 (불필요 데이터 제거 ) 및 연산 

→ SQL문의 시작 밑 끝단에서 고나여.

## SQL 프로세스 용어

: SQL문 실행 과정에 관한 용어들

### 동작 개요

![D30D5D21-E46F-4D8A-8293-19E8AB01937D_1_201_a.heic](https://prod-files-secure.s3.us-west-2.amazonaws.com/acc36000-d256-402d-b556-1ea406ceaf8a/0e6be87f-2f36-4c55-8785-f657794ebcc9/D30D5D21-E46F-4D8A-8293-19E8AB01937D_1_201_a.heic)

SQL문 수행 → MySQL 최소단위 분리 및 트리 작성(파서)→ 문법 오류 검토 → 생성된 트리의 유효성 검사(전처리기)→데이터 검색 실행계획 수립(옵티마이저) → 수립된 실행 계획 실행, 스토리지 엔진 호출( 엔진 실행기) → 불필요 데이터 필터링 및 결과전달.

### 파서

사용자가 요청한 SQL문을 쪼개 최소단위로 분리 

>.<.= 등의 기호나 SQL 키워드로 분리

트리 제작시 문법검사 수행

### 전처리기

파서가 생성한 트리를 토대로, SQL문의 구조적 문제 검사.

테이블,열,함수,뷰와같은 오브젝트의 유효성 및 접근 권한 확인

### 옵티마이저

MySQL의 핵심 엔진. DBMS의 두뇌.

파서 트리를 토대로, 불필요조건 제거나 연산 과정 단순화.

인덱스 사용 여부나 어떤 순서로 테이블에 접근할지 등. 실행계획 수립

실행계획의 경우의수가 지나치게 많을때는 모든 계획을 판단하지는 않음 

→ 최상의 실행 계획이 아닐 가능성 존재. 대기시간 및 리소스를 사용하므로 사용자의 적절한 제어 필요

### 엔진 실행기

옵티마이저에서 수립한 계획을 참고해 스토리지 엔진에서 데이터를 가져옴.

읽어온 데이터에 따라 정렬,조인,필터링등의 추가 작업 실시

→부하를 줄이려면, 스토리지에서 가져오는 데이터 양 조정 필요.

## DB오브젝트 용어

:DB를 구성하는 Object들의 개념

### 테이블

2차원 배열 형태의 오브젝트. 행과 열의 정보를 담음. 

### 로우(행)

가로줄. 동일한 구조의 데이터 항목의 집합. 

행 수가 많아질수록 데이터 접근시 시간의 소요 증가. →파티셔닝으로 해결

### 컬럼(열)

세로줄. 열별로 다른 데이터 유형. 

### 기본키(PK)

특정 행을 대표하는 열. 

상황에 따라 두개 이상의 열을 조합해서 형성. 

인덱스 역할 수행

MySQL/MaraiDB에서 기본키는 클러스터형 인덱스로 작동

→기본키의 구성 열 순서를 기준으로 물리적 스토리지에 쌓임

→비슷한 기본 키 값들이 근거리에 적재. 인덱스 스캔 효율성 증가

주의사항

기본키와 똑같은 인덱스 생성시 물리적 공간 낭비, 데이터 접근시 인덱스 정렬 오버헤드 발생.

### 외래키(FK)

외부 테이블을 항상 참조하며 영향을 받는 관계를 설정하는 키.

→ 외부테이블을 부모테이블, 외래키를 보유한 테이블이 자식 테이블이라고 생각

```sql
CREATE TABLE 전공 (
	전공코드 CHAR(2) NOT NULL,
	
--- 

CREATE TABLE 학생(
	CONSTRAINT 학생_FK1 FOREIGN KEY (전공코드) REFERENCES 전공(전공코드)

```

### 인덱스

데이터베이스에서 키값으로 실제 데이터 위치 식별, 데이터 접근 속도를 높이고자 생성되는 

키 기준으로 정렬된 오브젝트

### 고유 인덱스

인덱스를 구성하는 열들의 데이터가 유일성을 유지. 중복되지 않음

```sql
ADD UNIQUE INDEX ___ 
```

기본 키와 고유 인덱스

공통점 : 데이터 유일성 보장 필요, 데이터 접근을 위한 인덱스의 수단으로 사용됨

차이점 : 기본 키에는 NULL 입력 불가. 고유 인덱스에는 가능

### 비고유 인덱스

고유 인덱스 - 유일성 = 비고유인덱스

데이터가 신규 입려고디어 인덱스가 재정렬되어도 인덱스 열의 중복 체크를 거치지 않아 단순한 정렬 가능

```sql
ADD INDEX ___
```

### 뷰

가상 테이블같은 개념.  원 데이터 테이블이 변경되면 즉시 변경됨.

```sql
CREATE VIEW ___ AS
SELECT __ __ 
	FROM __ __ 

```

사용 이유 : 일부 데이터에 대해서만 공개하고, 노출에 민감한 데이터에 대해 제약 설정 가능 - 보안성 제공

여러 테이블을 병합(조인) 해서 활용할때 성능을 고려한 최적화된 뷰를 생성해서 일관된 성능 제공 가능

## 논리적 SQL 개념 용어

:주변 오브젝트와, SQL문 상호관계, 연관성 및 알고리즘 관련 용어

### 서브쿼리 위치에 따른 용어

서브쿼리 : 쿼리 안의 보조쿼리를 가리키는 용어

외부 SELECT 문인 메인쿼리 기준 내부에 어떤 위치에 작성되었는지에 따라 용어가 달라짐.

![IMG_4997.heic](https://prod-files-secure.s3.us-west-2.amazonaws.com/acc36000-d256-402d-b556-1ea406ceaf8a/d8a51640-70b5-423a-b50d-1ed5dd053bbc/IMG_4997.heic)

### SELECT 절 : 스칼라 서브쿼리

스칼라 서브쿼리의 결과값은, 최종 출력하려는 열이 나열되므로 출력 데이터 1건과 스칼라 서브쿼리의 결과 건수가 일치해야 함. → 1행 1열의 구조로 출력되어야 한다.

보통 집계함수(max,min,avg,sum,count) 등이 자주 쓰임

```sql
SELECT __,
(SELECT COUNT(*)
	FROM __ AS __
	WHERE ____ = ____ )
```

### FROM절 : 인라인 뷰

FROM 절 내부에서 일시적으로 뷰를 생성하는 방식.

결과는 내부적으로 메모리 또는 디스크에 임시 테이블 생성해서 활용

```sql
SELECT __, __
	FROM (SELECT *
					FROM __
					WHERE __ = __)
```

### 중첩 서브쿼리

WHERE 절에서 단순한 값 비교연ㅅ나이 아닌, 서브쿼리 추가해서 비교 연산을 위해 사용.

비교연산자를 비롯해 IN, EXISTS, NOT IN, NOT EXISTS 문 사용

```sql
SELECT *
	FROM __
	WHERE __ = (SELECT MAX(_) FROM __)
```

## 메인쿼리와의 관계성에 따른 SQL 용어

:서브쿼리와 메인쿼리의 관계성에 따른 SQL 용어

### 비상관 서브쿼리

메인쿼리와의 관계성이 없는 서브쿼리.

독자적 실행 뒤 결과값 전달

서브쿼리 실행→ 메인쿼리 실행의 순서로 실행됨

옵티마이저에 따라 서브쿼리가 제거되고 메인쿼리로 통합되는 뷰 병합(SQL 재작성) 이 일어나기도 함.

### 상관 서브쿼리

메인쿼리와의 관계성이 존재하는 서브쿼리

SELECT 절에 작성하는 스칼라 서브쿼리와 WHERE 절에 작성하는 중첩 서브쿼리의 경우 발생

서로 영향을 받기 때문에 다음과 같이 작동 :

메인쿼리실행→서브쿼리실행→다시 메인쿼리 실행 후 결과 출력

## 반환 결과에 따른 SQL 용어

결과 유형에 따른 분류. 1개 행 데이터, 2개 행 데이터 , 2개 이상의 행열데이터

### 단일행 서브쿼리

결과가 1건의 행으로 반환되는 쿼리 

메인쿼리의 조건절에서 비교연산자와 비교됨. 

스칼라 서브쿼리와 동일하다고 볼수있음

### 다중행 서브쿼리

서브쿼리 결과가 여러건의 행으로 반환됨

메인쿼리의 조건절에서 IN 구문으로 이러한 서브쿼리 반환값을 받음.

### 다중열 서브쿼리

서브쿼리 결과가 여러 열과 행으로 반환됨. 

메인쿼리 조건절에서는 IN 구문으로 반환값 받음
